defmodule CpuUtilTest do
  use ExUnit.Case
  doctest CpuUtil

  setup do
    {:ok, stat1: stat1(), stat2: stat2()}
  end

  test "stat/1 binary", %{stat1: stat} do
    expected = [
      "cpu",
      11_380_053,
      51,
      3_665_881,
      1_638_097_578,
      194_367,
      213,
      149_713,
      110_770,
      0
    ]

    assert stat |> elem(0) |> CpuUtil.stat() == expected
  end

  test "stat_pid/1 binary", %{stat2: stat} do
    expected = %{
      cmaj_flt: 0,
      cmin_flt: 5826,
      cstime: 0,
      cutime: 0,
      flags: 4_202_496,
      maj_flt: 0,
      min_flt: 189_950,
      pgrp: 9930,
      pid: 9930,
      ppid: 24113,
      sid: 24113,
      state: "S",
      stime: 1927,
      tcomm: "(beam.smp)",
      tty_nr: 34817,
      tty_pgrp: 9930,
      utime: 12027
    }

    assert stat |> elem(1) |> CpuUtil.stat_pid() == expected
  end

  test "process_util/3", %{stat1: prev, stat2: curr} do
    assert CpuUtil.process_util(prev, curr, cores: 6) == %{sys: 0.4, total: 1.3, user: 0.8}
  end

  defp stat1,
    do:
      {"""
       cpu  11380053 51 3665881 1638097578 194367 213 149713 110770 0
       cpu0 2593633 25 932385 271441155 125190 213 56429 36493 0
       cpu1 4056420 3 1078261 271109295 24855 0 51832 33370 0
       cpu2 1911464 19 683974 272982292 14612 0 22177 16876 0
       cpu3 1304462 1 421962 273804241 8429 0 12846 10579 0
       cpu4 756237 0 380800 274364515 17223 0 4362 5358 0
       cpu5 757834 0 168497 274396078 4055 0 2066 8092 0
       intr 1893317733 117 7 0 0 0 0 0 0 1 0 0 1378575 104 0 0 214 0 0 0 0 0 0 0 0 0 22 0 3308291 0 1660 0 82739616 1231 0 72 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
       ctxt 2963099168
       btime 1600622981
       processes 26130033
       procs_running 1
       procs_blocked 0
       softirq 1230393695 0 445349886 52 171102841 3224872 0 2 97597213 1408845 511709984
       """,
       "9930 (beam.smp) S 24113 9930 24113 34817 9930 4202496 189946 5826 0 0 12025 1926 0 0 20 0 28 0 275236728 3164401664 42600 18446744073709551615 4194304 7475860 140732561929584 140732561927920 256526653091 0 0 4224 134365702 18446744073709551615 0 0 17 3 0 0 0 0 0"}

  def stat2,
    do:
      {"""
       cpu  11380060 51 3665883 1638099001 194367 213 149713 110770 0
       cpu0 2593637 25 932387 271441391 125190 213 56429 36493 0
       cpu1 4056420 3 1078261 271109533 24855 0 51832 33370 0
       cpu2 1911467 19 683974 272982527 14612 0 22177 16876 0
       cpu3 1304462 1 421962 273804479 8429 0 12846 10579 0
       cpu4 756237 0 380800 274364753 17223 0 4362 5358 0
       cpu5 757834 0 168497 274396316 4055 0 2066 8092 0
       intr 1893319075 117 7 0 0 0 0 0 0 1 0 0 1378577 104 0 0 214 0 0 0 0 0 0 0 0 0 22 0 3308291 0 1660 0 82739672 1231 0 72 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
       ctxt 2963101252
       btime 1600622981
       processes 26130035
       procs_running 1
       procs_blocked 0
       softirq 1230394517 0 445350180 52 171102946 3224872 0 2 97597291 1408846 511710328
       """,
       "9930 (beam.smp) S 24113 9930 24113 34817 9930 4202496 189950 5826 0 0 12027 1927 0 0 20 0 28 0 275236728 3164401664 42600 18446744073709551615 4194304 7475860 140732561929584 140732561927920 256526653091 0 0 4224 134365702 18446744073709551615 0 0 17 3 0 0 0 0 0"}
end
